---
title: "3D Model Analysis of Fate-tracked M. cavernosa colonies"
author: "Ian Combs -- icombs2017@fau.edu"
output:
  html_document:
    theme: flatly
    code_folding: show
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_doctument:
      toc: yes
      toc_depth: 3
---
```{r, setup, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, fig.align = 'left')
knitr::opts_knit$set(root.dir = "../data")
options(width = 88)
library(magrittr)
```

### version: `r Sys.Date() %>% format(format="%B %d, %Y")`

<!-- this is where the DOI would go  [![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.3675991.svg)](https://doi.org/10.5281/zenodo.3675991)
-->


#### [GitHub repository](https://github.com/icombs2017/analysisOf3dModels.git){target="_blank"}


###
***
This is the analysis pipeline to analyze data generated from 3D models of fate tracked *Montastraea cavernosa* infected with stony coral tissue loss disease.

***

### All analyses performed with R version `r getRversion()`


# Basic setup of R environment
***
## Loading required packages
For the following analyses we will require the use of a number of different R packages. Most of which can be sourced from CRAN, but some must be downloaded from GitHub. We can use the following code to load in the packages and install any packages not previously installed in the R console. 

```{r,packages, include = TRUE, message = FALSE, warning = FALSE, results = 'hide'}
setwd("../data")
if (!require("pacman")) install.packages("pacman")
pacman::p_load("ggplot2", "FSA", "officer", "gridExtra", "ggpubr", "Rmisc", "rcompanion", "RColorBrewer", "vegan", "nparcomp", "RVAideMemoire", "pairwiseAdonis", "PMCMR", "PMCMRplus", "patchwork", "magrittr","reshape2", "stringr", "dplyr", "flextable")
pacman::p_load_gh("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")

```
<br><br>

# Loading and subsetting
***
Loading the dataset into R, and subsetting as needed, we will be making multiple subsets, subsetting by time point and by site to make things easier to workwith. 

```{r, load and subset, include = TRUE, results = "hide"}
corr <- read.csv("../data/total.correlation.csv", header = T)
str(corr)
head(corr)

# Changing values to cm^2
corr$total.colony.size <- corr$total.colony.size*10000
corr$healthy.area <- corr$healthy.area*10000
corr$disease.area <- corr$disease.area*10000

# I am reordering the dates in my data set to ensure 
# that they display chronologically.
corr$site = factor(corr$site, levels=unique(corr$site)) 
class(corr$date)
corr$date = as.factor(corr$date)
levels(corr$date)
corr$date = factor(corr$date, levels(corr$date)[c(3, 4, 1, 2)])
levels(corr$date)

# Subsetting by timepoint, and then resetting the factor level for each timepoint
corr.t1 <- subset(corr, date == '8.24.18')
droplevels(corr.t1$date)

corr.t2 <- subset(corr, date == '9.11.18')
droplevels(corr.t2$date)

corr.t3 <- subset(corr, date == '11.8.18')
droplevels(corr.t3$date)

corr.t4 <- subset(corr, date == '12.17.18')
droplevels(corr.t4$date)

# This will be used when we analyze rates of loss and disease progression
corr.loss <- subset(corr, date != '8.24.18')
droplevels(corr.loss$date)



# Subsetting by Site 
# (you can reset the factor for each site if needed from the code above)
corr.bc1 <- subset(corr, site == 'BC1')
corr.t328 <- subset(corr, site == 'T328')
corr.ftl4 <- subset(corr, site == 'FTL4')

# Average colony size from each site
mean(corr.bc1$total.colony.size)
mean(corr.t328$total.colony.size)
mean(corr.ftl4$total.colony.size)

# Subsetting the first time point from each location
corr.t1.bc1 <- subset(corr, site == "BC1")
corr.t1.t328 <- subset(corr, site == 'T328')
corr.t1.ftl4 <- subset(corr, site == "FTL4")

# Initial average colony size for each site
mean(corr.t1.bc1$total.colony.size)
mean(corr.t1.t328$total.colony.size)
mean(corr.t1.ftl4$total.colony.size)
```

<br><br>

# Assessing normality
***
A Shapiro-Wilk Normality Test will be run on our 3 main variables to assess normality

```{r, normality, include = TRUE}
shapiro.total <- shapiro.test(corr$total.colony.size)
shapiro.total

shapiro.healthy <-  shapiro.test(corr$healthy.area)
shapiro.healthy

shapiro.disease <- shapiro.test(corr$disease.area)
shapiro.disease

```

<br><br>

# Friedman Rank Sum Test
***
Performs a Friedman rank sum test with unreplicated blocked data on the three major area measurements: total colony area, healthy tissue area, and lesion area. 


```{r, Friedman, include = TRUE, results = "hide"}
fried.total <- friedmanTest(y=corr$total.colony.size, groups = corr$date, blocks = corr$colony.id)
fried.total 

fried.disease<- friedmanTest(y=corr$disease.area, groups = corr$date, blocks = corr$colony.id)
fried.disease

fried.healthy <- friedmanTest(y=corr$healthy.area, groups = corr$date, blocks = corr$colony.id)
fried.healthy

fried.lesion <- friedmanTest(y = corr$lesion.count, groups = corr$date, blocks = corr$colony.id)
fried.lesion
```

<br><br>

# Pairwise Comparisons using the Nemenyi test
***
Pairwise comparisons of significant Friedman's tests and manually adjusting the p values using a Bonferroni correction

```{r, Nemenyi, include = TRUE, results = "hide"}
# Total colony size
post.total <- posthoc.friedman.nemenyi.test(total.colony.size ~ date | colony.id, data = corr)
total.p.adjust <- p.adjust(post.total$p.value, method = "bonferroni")

# Making a string of the test statistic and melting 
# it into a column for making tables later
post.total.statistic = c(4.269075, 7.589466,9.012491, 3.320392, 4.743416, 1.423025)
post.total.statistic.melt = melt(post.total.statistic, id = 1)

#taking pvalues from Nemenyi test and manually correcting them
total.val <- c(0.0135,4.8e-07, 1.1e-09, 0.0875, 0.0044, 0.7458 )

# Using a bonferroni correction
adjust.total.val <- p.adjust(total.val, method = 'bonferroni')

# Now we are melting this vector (changing it from a row to a column) 
# so we can incorporate into a table later on
p.total.melt <- melt(adjust.total.val, id=1)



############################################
# Healthy tissue area
post.healthy <- posthoc.friedman.nemenyi.test(healthy.area ~ date | colony.id, data = corr)
post.healthy.statistic = c(4.743416, 7.115125,8.380036, 2.371708, 3.636619, 1.264911)
post.healthy.statistic.melt = melt(post.total.statistic, id = 1)

#taking pvalues from Nemenyi test and manually correcting them

healthy.val <- c(0.0044, 2.9e-06,  1.9e-08, 0.3358,0.0497, 0.8078 )

# Using a bonferroni correction
adjust.healthy.val <- p.adjust(healthy.val, method = 'bonferroni')

# Now we are melting this vector (changing it from a row to a column) 
# so we can incorporate into a table later on
p.healthy.melt <- melt(adjust.healthy.val, id=1)



############################################
#Lesion area
post.disease <- posthoc.friedman.nemenyi.test(disease.area ~ date | colony.id, data = corr)
post.disease.statistic = c(1.8973666, 0.6324555,3.1622777, 1.264911, 5.059644, 3.794733)
post.disease.statistic.melt = melt(post.total.statistic, id = 1)

#taking pvalues from Nemenyi test and manually correcting them
disease.val <- c(0.536, 0.970,  0.114, 0.808,0.002,0.037 )



# Using a bonferroni correction
adjust.disease.val <- p.adjust(disease.val, method = 'bonferroni')

# Now we are melting this vector (changing it from a row to a column) so we can incorporate into a table later on
p.disease.melt <- melt(adjust.disease.val, id=1)


```
<br><br>
Now we are building a table and exporting it as a **.docx** file for use in publications, reporting, etc.
```{r, friedTable, include = TRUE, ft.align = "left"}
friedTab = data.frame("Test" = "Total Colony Size", "Comparison" = " ", "Statistic" = fried.total[["statistic"]][["Friedman chi-squared"]], "p.value" = fried.total$p.value[1]) %>% 
  add_row("Test" = " ", "Comparison" = c("T1 - T2", "T1 - T3", "T1 - T4", "T2 - T3", "T2 - T4", "T3 - T4"), "Statistic" = post.total.statistic.melt$value, "p.value" = p.total.melt$value) %>% 
  add_row("Test" = "Healthy Tissue Area", "Comparison" = " ", "Statistic" =  fried.healthy[["statistic"]][["Friedman chi-squared"]], "p.value" = fried.healthy$p.value[1]) %>% 
  add_row("Test" = " ", "Comparison" = c("T1 - T2", "T1 - T3", "T1 - T4", "T2 - T3", "T2 - T4", "T3 - T4"), "Statistic" = post.healthy.statistic.melt$value, "p.value" = p.healthy.melt$value) %>% 
  add_row("Comparison" = " ", "Test" = "Disease Lesion Area", "Statistic" =  fried.disease[["statistic"]][["Friedman chi-squared"]], "p.value" = fried.disease$p.value[1]) %>% 
  add_row("Test" = " ", "Comparison" = c("T1 - T2", "T1 - T3", "T1 - T4", "T2 - T3", "T2 - T4", "T3 - T4"), "Statistic" = post.disease.statistic.melt$value, "p.value" = p.disease.melt$value) %>% 

mutate_if(is.numeric, round, digits = 3) %>%     
mutate(p.value = replace(p.value, p.value >= 0.05, "ns")) %>%
mutate(p.value = replace(p.value, p.value < 0.001, "< 0.001")) %>% 
mutate_if(is.character, str_replace_all, pattern = "-", replacement = "–") %>%
flextable() %>%
set_header_labels(Data.set = "Data set") %>% 
flextable::compose(part = "header", j = "Statistic", value = as_paragraph("Test Statistic")) %>%
flextable::compose(part = "header", j = "p.value", value = as_paragraph(as_i("p"), "-value")) %>% 
autofit() %>%
font(fontname = "Times New Roman", part = "all") %>%
fontsize(size = 12, part = "all") %>%
bold(part = "header") %>% 
colformat_num(j = "Statistic", digits = 2) %>%
colformat_num(j = "p.value", digits = 4, na_str = "ns") %>% 
align_nottext_col(align = "center", header = TRUE, footer = TRUE) %>% 
align(align = "center", j = "p.value")

friedDoc = read_docx()
friedDoc = body_add_flextable(friedDoc, value = friedTab)
print(friedDoc, target = "../tables/friedTable.docx")
friedTab
```


# Running PERMANOVA in R
***
We will be using the ```adonis()``` function in *vegan*. We will run a total of 999 permutations and test the effects of site, time, and the interaction between the two factors.


```{r, PERMANOVA, include = TRUE}
set.seed(999)
perm <- adonis(formula = corr[c(5:7)] ~ site * date, data = corr, method = "euclidian", perm = 999)
perm 
```


PERMANOVA reveals that Site has a significant effect on tissue areas. 

<br><br>

# Pairwise PERMANOVA for multiple comparisons
***
We found that Site was a significant factor in our PERMANOVA, so we are using a pairwise PERMANOVA using the function `pairwise.adonis()` from the package *pairwiseAdonis* to see where differences are between our sites.

```{r, pairwise permanova, include = TRUE }
set.seed(999)
perm.pair <- pairwise.adonis(corr[5:7],factors=corr$site,
                             sim.method='euclidian',p.adjust.m='bonferroni', perm = 999)
perm.pair
```
BC1 is significantly different from both T328 and FTL4. 

<br><br>
Now we are making a table for both our PERMANOVA results and our pairiwse tests.

```{r, permTab, include = TRUE, ft.align = "left"}
permTab = data.frame("Data" = "Surface Area", "Test" = "PERMANOVA", "Comparison" = "Site", "pseudo.F" = perm$aov.tab$F.Model[1], "p.value" = perm$aov.tab$`Pr(>F)`[1]) %>% 
  add_row("Data" = " ", "Test" = c("Pairwise", replicate(nrow(perm.pair)-1,"")), "Comparison" = perm.pair$pairs, "pseudo.F" = perm.pair$F.Model, "p.value" = perm.pair$p.adjusted) %>% 
  add_row("Data" = " ", "Test" = "PERMANOVA", "Comparison" = "Date", "pseudo.F" = perm$aov.tab$F.Model[2], "p.value" = perm$aov.tab$`Pr(>F)`[2]) %>% 
  add_row("Data" = " ", "Test" = "PERMANOVA", "Comparison" = "Site:Date", "pseudo.F" = perm$aov.tab$F.Model[3], "p.value" = perm$aov.tab$`Pr(>F)`[3]) %>% 
  
mutate(p.value = replace(p.value, p.value >= 0.05, NA)) %>%
mutate_if(is.character, str_replace_all, pattern = "vs", replacement = "–") %>%
flextable() %>%
set_header_labels(Data.set = "Data set") %>% 
flextable::compose(part = "header", j = "pseudo.F", value = as_paragraph("Psuedo-", as_i("F"))) %>%
flextable::compose(part = "header", j = "p.value", value = as_paragraph(as_i("p"), "-value")) %>% 
autofit() %>%
font(fontname = "Times New Roman", part = "all") %>%
fontsize(size = 12, part = "all") %>%
bold(part = "header") %>% 
colformat_num(j = "pseudo.F", digits = 2) %>%
colformat_num(j = "p.value", digits = 4, na_str = "ns")

permanovaDoc = read_docx()
permanovaDoc = body_add_flextable(permanovaDoc, value = permTab)
print(permanovaDoc, target = "../tables/permanovaTable.docx")
permTab
```
<br><br>

# Correlation Analyses
***
Multiple correlation analyses were carried out to see how different colony metrics affected disease manifestation and progress. 

```{r, correlation analyses, warning = FALSE, include = TRUE}

# Looking at correlation between total colony size and disease lesion area

colonysize.vs.lesionarea <- cor.test(corr$total.colony.size,corr$disease.area, method="spearman", use="complete.obs")


# Looking at correlation between total colony size and the number of disease lesions on a colony

colonysize.vs.lesioncount<- cor.test(corr$total.colony.size,corr$lesion.count, method="spearman", use="complete.obs")

# Looking at correlation between the amount of lesion tissue area and number of disease lesions

lesionarea.vs.lesioncount <- cor.test(corr$disease.area,corr$lesion.count, method="spearman", use="complete.obs")


```
```{r, correlationResults, echo = FALSE}

spearSizeTab = data.frame("Data" = "Rate of Tissue Loss", "Test" = "Spearman's Rank Correlation", "Comparison" = "Colony Size vs Lesion Area ", "rho" = colonysize.vs.lesionarea[["estimate"]][["rho"]], "p.value" = colonysize.vs.lesionarea$p.value) %>% 
  add_row("Data" = " ", "Test" = " ", "Comparison" = "Colony Size vs Lesion Count", "rho" = colonysize.vs.lesioncount[["estimate"]][["rho"]], "p.value" = colonysize.vs.lesioncount$p.value) %>% 
  add_row("Data" = " ", "Test" = " ", "Comparison" = "Lesion Area vs Lesion Count", "rho" = lesionarea.vs.lesioncount[["estimate"]][["rho"]], "p.value" = lesionarea.vs.lesioncount$p.value) %>% 
  
mutate(p.value = replace(p.value, p.value >= 0.05, NA)) %>%
mutate(p.value = replace(p.value, p.value < 0.001, "< 0.001")) %>% 
mutate_if(is.character, str_replace_all, pattern = "vs", replacement = "–") %>% 
flextable() %>%
set_header_labels(Data.set = "Data") %>% 
flextable::compose(part = "header", j = "rho", value = as_paragraph("𝜌")) %>%
flextable::compose(part = "header", j = "p.value", value = as_paragraph(as_i("p"), "-value")) %>% 
autofit() %>%
font(fontname = "Times New Roman", part = "all") %>%
fontsize(size = 12, part = "all") %>%
bold(part = "header") %>% 
colformat_num(j = "rho", digits = 3) %>%
colformat_num(j = "p.value", digits = 4, na_str = "ns") %>% 
align(align = "center", j = "p.value") %>% 
align(align = "center", j = "rho")


spearSizeDoc = read_docx()
spearSizeDoc = body_add_flextable(spearSizeDoc, value = spearSizeTab)
print(spearSizeDoc, target = "../tables/spearSizeTab.docx")

```
<br><br>

The number of disease lesions were positively correlated with the amount of disease lesion tissue area. However, colony size was not correlated with disease lesion area or the number of disease lesions. So, bigger colonies have no more (or less) disease than smaller colonies. 
<br><br>

# Analysis of Lesion Count using Kruskal-Wallis and Dunn's Test
***
Looking at differences of lesion count among site.
```{r, lesionCountAnalyses, include = TRUE}
lesion.kw <- kruskal.test(lesion.count ~ site, data = corr)

lesion.kw.dunn <- dunnTest(lesion.count ~ site, data = corr, method = 'bh')

```
```{r, lesionCountAnalysesOutputs, include = TRUE, echo = FALSE}
lesionKwTab = data.frame("Data" = "Lesion Count", "Test" = "Kruskal-Wallis", "Comparison" = "Site ", "TestStatistic" = lesion.kw[["statistic"]][["Kruskal-Wallis chi-squared"]], "p.value" = lesion.kw[["p.value"]]) %>% 
  add_row(data.frame("Data" = " ", "Test" = c("Pairwise", " ", " "), "Comparison" = lesion.kw.dunn[["res"]][["Comparison"]], "TestStatistic" = lesion.kw.dunn[["res"]][["Z"]], "p.value" = lesion.kw.dunn[["res"]][["P.adj"]])) %>% 

mutate_if(is.numeric, round, digits = 3) %>%     
mutate(p.value = replace(p.value, p.value >= 0.05, NA)) %>%
mutate(p.value = replace(p.value, p.value < 0.001, "< 0.001")) %>% 
flextable() %>%
set_header_labels(Data.set = "Data") %>% 
flextable::compose(part = "header", j = "TestStatistic", value = as_paragraph("Test Statistic")) %>%
flextable::compose(part = "header", j = "p.value", value = as_paragraph(as_i("p"), "-value")) %>% 
autofit() %>%
font(fontname = "Times New Roman", part = "all") %>%
fontsize(size = 12, part = "all") %>%
bold(part = "header") %>% 
colformat_num(j = "TestStatistic", digits = 3) %>%
colformat_num(j = "p.value", digits = 4, na_str = "ns") %>% 
align(align = "center", j = "p.value") %>% 
align(align = "center", j = "TestStatistic")


lesionKwDoc = read_docx()
lesionKwDoc = body_add_flextable(spearSizeDoc, value = lesionKwTab)
print(lesionKwDoc, target = "../tables/lesionKwTab.docx")

lesionKwTab



```

# Plotting
***
We are now going to make a number of box plots and correlation plots to visualize the data we just analyzed. I will display the code for one of each (as the code is the same just replacing variable names) and then I will compile the plots using the R package *patchwork*.

# Box Plots

```{r, boxplot.example, include = TRUE, results = "hide"}
# This forces y axis labels to have 1 decimal place.
scale <- function(x) sprintf("%.0f", x)

# Plotting a boxplot of mean total colony size for each site at each timepoint. 
total.colony.box.1 <-
  ggplot(data = corr, aes(x = date, y = total.colony.size))+
  geom_boxplot(aes(fill = site), alpha = 1, outlier.shape = NA, color = "black") +
  geom_point(aes(fill = site), color = "black", size = 3, position = position_jitterdodge()) +
  scale_fill_manual(values = c("#7BA46C", "#EACF9E", "#008D91")) +
  scale_x_discrete(labels = c(expression('T'[1]), expression('T'[2]), expression('T'[3]), expression('T'[4])))+
  labs(x = "Time", y = bquote("Total Colony Area" ~ (cm^2)),fill = 'Site') +
  scale_y_continuous(labels = scale)+
  theme(legend.title = element_blank(),
        legend.text = element_text(color = "black", size = 25),
        legend.background = element_blank())+
  facet_grid(.~site,scales="free")
total.colony.box.1

total.colony.box <- total.colony.box.1 + theme(
  panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),
  panel.background = element_rect(fill = '#F5F5F5'),
  plot.title = element_text(hjust = 0.5), 
  axis.line = element_line(colour = "black"), 
  axis.ticks = element_line(color="black"), 
  text = element_text(size=15, color="black"), 
  axis.text.x=element_text(size=12, color="black"), 
  axis.text.y=element_text(size=12, color="black"),
  axis.title.y = element_text(size = 18, color = 'black'),
  plot.margin = unit(c(0.5, 1, 0.5, 1), "cm"))+ 
  rremove("legend")

total.colony.box
```
We repeat this using healthy tissue area, disease lesion area and lesion count. 
```{r, rest.of.boxplots, results = "hide", echo = FALSE}
# This forces y axis labels to have 1 decimal place.
scale <- function(x) sprintf("%.0f", x)

# Plotting a boxplot of mean healthy tissue area for each site at each timepoint. 
healthy.colony.box.1 <-
  ggplot(data = corr, aes(x = date, y = healthy.area))+
  geom_boxplot(aes(fill = site), alpha = 1, outlier.shape = NA, color = "black") +
  geom_point(aes(fill = site), color = "black", size = 3, position = position_jitterdodge()) +
  scale_fill_manual(values = c("#7BA46C", "#EACF9E", "#008D91")) +
  scale_x_discrete(labels = c(expression('T'[1]), expression('T'[2]), expression('T'[3]), expression('T'[4])))+
  labs(x = "Time", y = bquote("Healthy Tissue Area" ~ (cm^2)),fill = 'Site') +
  scale_y_continuous(labels = scale)+
  theme(legend.title = element_blank(),
        legend.text = element_text(color = "black", size = 25),
        legend.background = element_blank())+
  facet_grid(.~site,scales="free")
healthy.colony.box.1

healthy.colony.box <- healthy.colony.box.1 + theme(
  panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),
  panel.background = element_rect(fill = '#F5F5F5'),
  plot.title = element_text(hjust = 0.5), 
  axis.line = element_line(colour = "black"), 
  axis.ticks = element_line(color="black"), 
  text = element_text(size=15, color="black"), 
  axis.text.x=element_text(size=12, color="black"), 
  axis.text.y=element_text(size=12, color="black"),
  axis.title.y = element_text(size = 18, color = 'black'),
  plot.margin = unit(c(0.5, 1, 0.5, 0.5), "cm"))+ 
  rremove("legend")

healthy.colony.box

# Plotting box plot of mean disease lesion area for each site at each timepoint.

disease.area.box.1 <-
  ggplot(data = corr, aes(x = date, y = disease.area))+
  geom_boxplot(aes(fill = site), alpha = 1, outlier.shape = NA, color = "black") +
  geom_point(aes(fill = site), color = "black", size = 3, position = position_jitterdodge()) +
  scale_fill_manual(values = c("#7BA46C", "#EACF9E", "#008D91")) +
  scale_x_discrete(labels = c(expression('T'[1]), expression('T'[2]), expression('T'[3]), expression('T'[4])))+
  labs(x = "Time", y = bquote('Disease Lesion Area'~(cm^2)), fill = 'Site') + 
  scale_y_continuous(labels = scale)+
  theme(legend.title = element_blank(),
        legend.text = element_text(color = "black", size = 25),
        legend.background = element_blank())+
  facet_grid(.~site,scales="free")
disease.area.box.1

disease.area.box <- disease.area.box.1 + theme(
  panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),
  panel.background = element_rect(fill = '#F5F5F5'),
  plot.title = element_text(hjust = 0.5), 
  axis.line = element_line(colour = "black"), 
  axis.ticks = element_line(color="black"), 
  text = element_text(size=15, color="black"), 
  axis.text.x=element_text(size=12, color="black"), 
  axis.text.y=element_text(size=12, color="black"),
  axis.title.y = element_text(size = 18, color = 'black'),
  plot.margin = unit(c(0.5, 1, 0.5, 1), "cm"))+ 
  rremove("legend")

disease.area.box

# Plotting box plot of mean lesion count for each site at each timepoint.

lesion.count.box.1 <- ggplot(data = corr, aes(x = date, y = lesion.count))+
  geom_boxplot(aes(fill = site), alpha = 1, outlier.shape = NA, color = "black") +
  geom_point(aes(fill = site), color = "black", size = 3, position = position_jitterdodge()) +
  scale_fill_manual(values = c("#7BA46C", "#EACF9E", "#008D91")) +
  scale_x_discrete(labels = c(expression('T'[1]), expression('T'[2]), expression('T'[3]), expression('T'[4])))+
  labs(x = "Site", y = "Number of Lesions", fill = 'Site') + 
  scale_y_continuous(labels = scale)+
  theme(legend.title = element_blank(),
        legend.text = element_text(color = "black", size = 25),
        legend.background = element_blank())+
  facet_grid(.~site,scales="free")
lesion.count.box.1

lesion.count.box <- lesion.count.box.1 + theme(
  panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),
  panel.background = element_rect(fill = '#F5F5F5'),
  plot.title = element_text(hjust = 0.5), 
  axis.line = element_line(colour = "black"), 
  axis.ticks = element_line(color="black"), 
  text = element_text(size=15, color="black"), 
  axis.text.x=element_text(size=12, color="black"), 
  axis.text.y=element_text(size=12, color="black"),
  axis.title.y = element_text(size = 18, color = 'black'),
  plot.margin = unit(c(0.5, 1, 0.5, 2), "cm"))+ 
  rremove("legend")

lesion.count.box

```
<br><br>

# Correlation Plots
Here I will be showing the code for a significant and a non-significant correlation plot as there will be slight difference in the code showing the correlation trend. 

```{r, correlation.example, include = TRUE, results = "hide"}
# No correlation
lesion.count.colony.size.1 <-ggplot(corr, aes(x = total.colony.size, y = lesion.count, color = site))+
  geom_point(size = 5)+
  scale_color_manual(values = c("#7BA46C", "#EACF9E", "#008D91"))+
  labs(x = bquote('Total Colony Size'~(cm^2)), y = bquote('Cattle Tag Error'~(cm^2)))+
  scale_y_continuous(labels = scale)

lesion.count.colony.size <- lesion.count.colony.size.1 + 
  theme(panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),                 panel.background = element_rect(fill = '#F5F5F5'),
        plot.title = element_text(hjust = 0.5), 
        axis.line = element_line(colour = "black"), 
        axis.ticks = element_line(color="black"), 
        text = element_text(size=15, color="black"), 
        axis.text.x=element_text(size=12, color="black"), 
        axis.text.y=element_text(size=12, color="black"),
        axis.title.y = element_text(size = 18, color = 'black'),
        plot.margin = unit(c(0.5, 1, 0.5, 1.75), "cm"))+
  rremove("legend")
lesion.count.colony.size 


# Significant Correlation

lesion.count.disease.area.1 <-ggplot(corr, aes(x = disease.area, y = lesion.count, color = site))+
  geom_point(size = 5)+
  geom_smooth(method = "lm", fill = 'grey30', color = 'grey30')+
  scale_color_manual(values = c("#7BA46C", "#EACF9E", "#008D91"))+
  labs(x = bquote('Disease Lesion Area'~(cm^2)), y = "Lesion Count") +
  scale_y_continuous(labels = scale)
lesion.count.disease.area.1


lesion.count.disease.area <- lesion.count.disease.area.1 + 
  theme(panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),                 panel.background = element_rect(fill = '#F5F5F5'),
        plot.title = element_text(hjust = 0.5), 
        axis.line = element_line(colour = "black"), 
        axis.ticks = element_line(color="black"), 
        text = element_text(size=15, color="black"), 
        axis.text.x=element_text(size=12, color="black"), 
        axis.text.y=element_text(size=12, color="black"),
        axis.title.y = element_text(size = 18, color = 'black'),
        plot.margin = unit(c(0.5, 1, 0.5, 1.57), "cm"))+
  rremove("legend")
lesion.count.disease.area 

```

```{r, correlation.rest, echo = FALSE, results = "hide"}
colony.size.disease.area.1 <-ggplot(corr, aes(x = total.colony.size, y = disease.area, color = site))+
  geom_point(size = 5)+
  scale_color_manual(values = c("#7BA46C", "#EACF9E", "#008D91"))+
  labs(x = bquote('Total Colony Area'~(cm^2)), y = bquote('Disease Lesion Area'~(cm^2))) +
  scale_y_continuous(labels = scale)
colony.size.disease.area.1


colony.size.disease.area <- colony.size.disease.area.1 + 
  theme(panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),                 panel.background = element_rect(fill = '#F5F5F5'),
        plot.title = element_text(hjust = 0.5), 
        axis.line = element_line(colour = "black"), 
        axis.ticks = element_line(color="black"), 
        text = element_text(size=15, color="black"), 
        axis.text.x=element_text(size=12, color="black"), 
        axis.text.y=element_text(size=12, color="black"),
        axis.title.y = element_text(size = 18, color = 'black'),
        plot.margin = unit(c(0.5, 1, 0.5, 1.5), "cm"))+
  rremove("legend")
colony.size.disease.area 
  
```
<br><br>

# Putting plots together using *patchwork*.
***
*patchwork* adds ggplot2 plots together to compose multiplot layouts using simple operators.

```{r, patch.lesion, include = TRUE}
lesion.plots.patch <- total.colony.box + healthy.colony.box + disease.area.box + lesion.count.box + colony.size.disease.area + lesion.count.disease.area + lesion.count.colony.size + guide_area() + plot_layout(nrow = 4, guides = 'collect')+plot_annotation(tag_levels = 'a')

## Save
ggsave("../figures/lesion.plots.png",  plot= lesion.plots.patch, width=20, height=20, units="in", dpi=600)

```

<br><br>
***

# Rates of Loss
***
Rates of loss were calculated between timepoints, looking at correlations. Kruskal-Wallis Rank Sum Tests were used to determine if rates of loss varied by site, and correlation analyses were used to determine if colony metrics were related to rates of tissue loss. 

```{r, loss.kw, include = TRUE }
rate.l1.kw <- kruskal.test(loss ~ site, data = corr.t2)
rate.l1.kw

rate.l2.kw <- kruskal.test(loss ~ site, data=corr.t3)
rate.l2.kw

rate.l3.kw <- kruskal.test(loss ~ site, data=corr.t4)
rate.l3.kw
```

# Correlation analyses
***
Correlation analyses were run on rates of loss and various colony metrics. 

```{r, loss.corr, include = TRUE, warning = FALSE}

## Rate of loss 1 and total colony size at T2
spear.t2 <- cor.test(corr.t2$loss,corr.t2$total.colony.size, method="spearman", use="complete.obs")

# Rate of loss 2 and total colony size at T3
spear.t3 <- cor.test(corr.t3$loss,corr.t3$total.colony.size, method="spearman", use="complete.obs")

# Rate of loss 3 and total colony size at T4
spear.t4 <- cor.test(corr.t4$loss,corr.t4$total.colony.size, method="spearman", use="complete.obs")

```

```{r, correlationTab, include = TRUE}
spearLossTab = data.frame("Data" = "Rate of Tissue Loss", "Test" = "Spearman's Rank Correlation", "Comparison" = "T1-T2 ", "rho" = spear.t2[["estimate"]][["rho"]], "p.value" = spear.t2$p.value) %>% 
  add_row("Data" = " ", "Test" = " ", "Comparison" = "T2-T3", "rho" = spear.t3[["estimate"]][["rho"]], "p.value" = spear.t3$p.value) %>% 
  add_row("Data" = " ", "Test" = " ", "Comparison" = "T3-T4", "rho" = spear.t4[["estimate"]][["rho"]], "p.value" = spear.t4$p.value) %>% 
  
mutate(p.value = replace(p.value, p.value >= 0.05, NA)) %>%
flextable() %>%
set_header_labels(Data.set = "Data") %>% 
flextable::compose(part = "header", j = "rho", value = as_paragraph("𝜌")) %>%
flextable::compose(part = "header", j = "p.value", value = as_paragraph(as_i("p"), "-value")) %>% 
autofit() %>%
font(fontname = "Times New Roman", part = "all") %>%
fontsize(size = 12, part = "all") %>%
bold(part = "header") %>% 
colformat_num(j = "rho", digits = 3) %>%
colformat_num(j = "p.value", digits = 4, na_str = "ns") %>% 
align(align = "center", j = "p.value")

spearLossDoc = read_docx()
spearLossDoc = body_add_flextable(spearLossDoc, value = spearLossTab)
print(spearLossDoc, target = "../tables/spearLossTab.docx")
```



# Visualizing rates of loss
***
Now using same types plots as before, but for loss data. I am excluiding the first time point, and will subset accordingly. And use the same code as above. 

```{r, loss.subset, include = TRUE, results = "hide"}
#subset
corr.loss <- subset(corr, date != "8.24.18")

```

```{r, loss.plots, echo = FALSE}

#------------box plot for L1---------------------------
scale <- function(x) sprintf("%.0f", x)

# boxplots comparing shape areas to template
rate.l1.box.1 <- ggplot(data = corr.loss, aes(x = date, y = loss))+
  geom_boxplot(aes(fill = site), alpha = 1, outlier.shape = NA, color = "black") +
  geom_point(aes(fill = site), color = "black", size = 3, position = position_jitterdodge()) +
  scale_fill_manual(values = c("#7BA46C", "#EACF9E", "#008D91")) +
  scale_x_discrete(labels = c(expression('T'[2]), expression('T'[3]), expression('T'[4])))+
  labs(x = "Time", y = bquote('Tissue Loss'~(cm^2/wk)), fill = 'Site') +
  scale_y_continuous(labels = scale)+
  theme(legend.title = element_blank(),
        legend.text = element_text(color = "black", size = 25),
        legend.background = element_blank())+
  facet_grid(.~site,scales="free")
rate.l1.box.1

rate.l1.box <- rate.l1.box.1 + theme(
  panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),
  panel.background = element_rect(fill = '#F5F5F5'),
  plot.title = element_text(hjust = 0.5), 
  axis.line = element_line(colour = "black"), 
  axis.ticks = element_line(color="black"), 
  text = element_text(size=15, color="black"), 
  axis.text.x=element_text(size=12, color="black"), 
  axis.text.y=element_text(size=12, color="black"),
  axis.title.y = element_text(size = 16, color = 'black'),
  plot.margin = unit(c(0.5, 1, 0.5, 2), "cm"))+ 
  rremove("legend")

rate.l1.box
  


#------------cor plot for L1 and T2------------------------
# correlation plots comparing area lost to total colony size

# makes a scatterplot of correlation
l1.total.colony.size.1 <-ggplot(corr.t2, aes(x = total.colony.size, y = loss, color = site))+
  geom_point(size = 5)+
  #geom_smooth(method = 'lm', color = 'grey30', fill = 'grey30')+
  scale_color_manual(values = c("#7BA46C", "#EACF9E", "#008D91"))+
  labs(x = bquote('Total Colony Size'~(cm^2)), y = bquote('Tissue Loss at T2'~(cm^2/wk))) +
  scale_y_continuous(labels = scale)
l1.total.colony.size.1


l1.total.colony.size <- l1.total.colony.size.1 + 
  theme(panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),                 panel.background = element_rect(fill = '#F5F5F5'),
        plot.title = element_text(hjust = 0.5), 
        axis.line = element_line(colour = "black"), 
        axis.ticks = element_line(color="black"), 
        text = element_text(size=15, color="black"), 
        axis.text.x=element_text(size=12, color="black"), 
        axis.text.y=element_text(size=12, color="black"),
        axis.title.y = element_text(size = 16, color = 'black'),
        plot.margin = unit(c(0.5, 1, 0.5, 2.5), "cm"))+
  rremove("legend")
l1.total.colony.size
  


#------------corr plot for l2 and t3---------------------------
# correlation plots comparing number of disease lesions to overall disease area

# makes a scatterplot of correlation
l2.total.colony.size.1 <-ggplot(corr.t3, aes(x = total.colony.size, y = loss, color = site))+
  geom_point(size = 5)+
  #geom_smooth(method = 'lm', color = 'grey30', fill = 'grey30')+
  scale_color_manual(values = c("#7BA46C", "#EACF9E", "#008D91"))+
  labs(x = bquote('Total Colony Size'~(cm^2)), y = bquote('Tissue Loss at T3'~(cm^2/wk))) +
  scale_y_continuous(labels = scale)
l2.total.colony.size.1


l2.total.colony.size <- l2.total.colony.size.1 + 
  theme(panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),                 panel.background = element_rect(fill = '#F5F5F5'),
        plot.title = element_text(hjust = 0.5), 
        axis.line = element_line(colour = "black"), 
        axis.ticks = element_line(color="black"), 
        text = element_text(size=15, color="black"), 
        axis.text.x=element_text(size=12, color="black"), 
        axis.text.y=element_text(size=12, color="black"),
        axis.title.y = element_text(size = 16, color = 'black'),
        plot.margin = unit(c(0.5, 1, 0.5, 2.5), "cm"))+
  rremove("legend")
l2.total.colony.size
  
#------------box plot for l3 and t4--------------------------
rate.l3.box.1 <- ggplot(data = corr.t4, aes(x = date, y = loss))+
  geom_boxplot(aes(fill = site), alpha = 1, outlier.shape = NA, color = "black") +
  geom_point(aes(fill = site), color = "black", size = 3, position = position_jitterdodge()) +
  scale_fill_manual(values = c("#7BA46C", "#EACF9E", "#008D91")) +
  scale_x_discrete(labels = c(expression('T'[2]), expression('T'[3])))+
  labs(x = "Time", y = bquote('Tissue Loss'~(cm^2/wk)), fill = 'Site') +
  scale_y_continuous(labels = scale)+
  theme(legend.title = element_blank(),
        legend.text = element_text(color = "black", size = 25),
        legend.background = element_blank())+
  facet_grid(.~site,scales="free")
rate.l3.box.1

rate.l3.box <- rate.l3.box.1 + theme(
  panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),
  panel.background = element_rect(fill = '#F5F5F5'),
  plot.title = element_text(hjust = 0.5), 
  axis.line = element_line(colour = "black"), 
  axis.ticks = element_line(color="black"), 
  text = element_text(size=15, color="black"), 
  axis.text.x=element_text(size=12, color="black"), 
  axis.text.y=element_text(size=12, color="black"),
  axis.title.y = element_text(size = 16, color = 'black'),
  plot.margin = unit(c(0.5, 1, 0.5, 2), "cm"))+ 
  rremove("legend")

rate.l3.box

#------------corr plot for l3 and t4--------------------------
l3.total.colony.size.1 <-ggplot(corr.t4, aes(x = total.colony.size, y = loss, color = site))+
  geom_point(size = 5)+
  #geom_smooth(method = 'lm', color = 'grey30', fill = 'grey30')+
  scale_color_manual(values = c("#7BA46C", "#EACF9E", "#008D91"))+
  labs(x = bquote('Total Colony Size'~(cm^2)), y = bquote('Tissue Loss at T4'~(cm^2/wk))) +
  scale_y_continuous(labels = scale)
l2.total.colony.size.1


l3.total.colony.size <- l3.total.colony.size.1 + 
  theme(panel.grid.major = element_line(size = 0.5, linetype = 'solid', colour = "white"),                 panel.background = element_rect(fill = '#F5F5F5'),
        plot.title = element_text(hjust = 0.5), 
        axis.line = element_line(colour = "black"), 
        axis.ticks = element_line(color="black"), 
        text = element_text(size=15, color="black"), 
        axis.text.x=element_text(size=12, color="black"), 
        axis.text.y=element_text(size=12, color="black"),
        axis.title.y = element_text(size = 16, color = 'black'),
        plot.margin = unit(c(0.5, 1, 0.5, 2.5), "cm"))
  # rremove("legend")
l3.total.colony.size

#------------Loss Plots--------------------------

loss.plots.patch <-(rate.l1.box + l1.total.colony.size) / (l2.total.colony.size + l3.total.colony.size) + plot_layout(guides = 'collect')+plot_annotation(tag_levels = 'a')
loss.plots.patch

ggsave("../figures/loss.plots.png", plot= loss.plots.patch, width=15, height=10, units="in", dpi=600)

```






